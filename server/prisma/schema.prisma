generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Phase 0: Core MVP
// ─────────────────────────────────────────────

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String
  lastName      String
  username      String?   @unique
  avatar        String?   @db.VarChar(1000)
  credits       Int       @default(5)
  referralBonus Int       @default(0)
  role          String    @default("USER")
  isActive      Boolean   @default(true)
  emailVerified        Boolean   @default(false)
  phone                String    @unique
  phoneVerified        Boolean   @default(false)
  otpRequestId         String?   @db.VarChar(255)
  passwordResetToken   String?   @db.VarChar(255)
  passwordResetExpiry  DateTime?
  deletedAt            DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  referralCode     String?    @unique
  referredById     String?

  refreshTokens    RefreshToken[]
  jobs             Job[]
  transactions     CreditTransaction[]
  brandingProfile  BrandingProfile?
  masterProfile    MasterProfile?
  reviews          Review[]         @relation("masterReviews")
  portfolioItems   PortfolioItem[]
  scheduledPosts   ScheduledPost[]
  subscription     Subscription?
  creditPurchases  CreditPurchase[]
  referralsGiven   Referral[]       @relation("referrerReferrals")
  referralReceived Referral?        @relation("referredReferral")

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique @db.VarChar(500)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

model Job {
  id          String   @id @default(uuid())
  userId      String?
  status      String   @default("PENDING")
  mode        String   @default("SINGLE")
  originalUrl String   @db.VarChar(1000)
  beforeUrl   String?  @db.VarChar(1000)
  results     Json?
  settings    Json?
  batchId         String?
  processingType  String   @default("ENHANCE")
  creditCost      Int      @default(1)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user     User?     @relation(fields: [userId], references: [id])
  captions Caption[]
  reviews  Review[]

  @@index([userId])
  @@index([status])
  @@index([batchId])
  @@map("jobs")
}

model CreditTransaction {
  id        String   @id @default(uuid())
  userId    String
  delta     Int
  reason    String
  jobId     String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("credit_transactions")
}

model CreditPackage {
  id          String   @id @default(uuid())
  name        String
  description String?
  credits     Int
  price       Int
  currency    String   @default("GEL")
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@map("credit_packages")
}

model CreditPurchase {
  id        String   @id @default(uuid())
  userId    String
  packageId String
  credits   Int
  amount    Int
  currency  String   @default("USD")
  status    String   @default("COMPLETED")
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@map("credit_purchases")
}

// ─────────────────────────────────────────────
// Phase 1: Platform Round 1
// ─────────────────────────────────────────────

model BrandingProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  displayName     String?
  instagramHandle String?
  facebookHandle  String?
  tiktokHandle    String?
  logoUrl         String?  @db.VarChar(1000)
  primaryColor    String   @default("#d4738a")
  watermarkStyle   String   @default("MINIMAL")
  watermarkOpacity Float    @default(1) @db.Float
  isActive         Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("branding_profiles")
}

model Review {
  id         String   @id @default(uuid())
  jobId      String
  masterId   String
  rating     Int
  text       String?  @db.Text
  clientName String?
  createdAt  DateTime @default(now())

  job    Job  @relation(fields: [jobId], references: [id])
  master User @relation("masterReviews", fields: [masterId], references: [id])

  @@index([masterId])
  @@index([jobId])
  @@map("reviews")
}

// ─────────────────────────────────────────────
// Phase 2: Sticky Features
// ─────────────────────────────────────────────

model MasterProfile {
  id        String   @id @default(uuid())
  userId    String   @unique
  city      String?
  niche     String?
  services  Json?
  bio       String?  @db.Text
  phone     String?
  whatsapp  String?
  telegram  String?
  instagram String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("master_profiles")
}

model Caption {
  id        String   @id @default(uuid())
  jobId     String
  variant   String
  language  String
  text      String   @db.Text
  hashtags  String   @db.Text
  createdAt DateTime @default(now())

  job Job @relation(fields: [jobId], references: [id])

  @@index([jobId])
  @@map("captions")
}

model PortfolioItem {
  id          String   @id @default(uuid())
  userId      String
  jobId       String?
  imageUrl    String   @db.VarChar(1000)
  title       String?
  niche       String?
  isPublished Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, isPublished])
  @@map("portfolio_items")
}

// ─────────────────────────────────────────────
// Phase 3: Engagement & Monetization
// ─────────────────────────────────────────────

model ScheduledPost {
  id          String   @id @default(uuid())
  userId      String
  jobId       String?
  imageUrl    String   @db.VarChar(1000)
  caption     String?  @db.Text
  hashtags    String?  @db.Text
  scheduledAt DateTime
  status      String   @default("SCHEDULED")
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId, scheduledAt])
  @@index([status])
  @@map("scheduled_posts")
}

model TrendTemplate {
  id          String   @id @default(uuid())
  title       String
  description String?  @db.Text
  previewUrl  String   @db.VarChar(1000)
  settings    Json
  weekOf      DateTime
  isFree      Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([isActive, weekOf])
  @@map("trend_templates")
}

model Subscription {
  id               String    @id @default(uuid())
  userId           String    @unique
  plan             String    @default("FREE")
  quality          String    @default("mid")
  status           String    @default("ACTIVE")
  autoRenew        Boolean   @default(true)
  cancelledAt      DateTime?
  stripeCustomerId String?
  stripeSubId      String?
  currentPeriodEnd DateTime
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([status, currentPeriodEnd])
  @@map("subscriptions")
}

model Referral {
  id            String   @id @default(uuid())
  referrerId    String
  referredId    String   @unique
  referredPhone String   @db.VarChar(20)
  rewardGiven   Boolean  @default(false)
  createdAt     DateTime @default(now())

  referrer User @relation("referrerReferrals", fields: [referrerId], references: [id], onDelete: Cascade)
  referred User @relation("referredReferral", fields: [referredId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([referredPhone])
  @@map("referrals")
}
